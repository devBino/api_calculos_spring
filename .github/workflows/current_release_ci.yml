name: CI/CD Microsservi√ßos Calculos

on:
    push:
        branches: [develop, master]

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Baixando Codigos Fontes
              uses: actions/checkout@v3

            - name: Logando no Docker Hub
              uses: docker/login-action@v2.0.0
              with:
                username: ${{ secrets.DOCKER_USERNAME }}
                password: ${{ secrets.DOCKER_PASSWORD }}

            - name: Setup JDK 18
              uses: actions/setup-java@v3
              with:
                distribution: 'temurin'
                java-version: '17'
                cache: maven

            - name: Build MS Calculos
              working-directory: ./api-rest
              run: mvn package -Pdevelopment

            - name: Build MS Calculos Processor
              working-directory: ./calculo-processor
              run: mvn package -Pdevelopment

            - name: Gerando Imagens com Docker Compose
              working-directory: ./
              run: docker compose build

            - name: Enviando Imagens para o Docker Hub
              run: |
                docker tag ${{ secrets.DOCKER_USERNAME }}/ms-calculos:latest ${{ secrets.DOCKER_USERNAME }}/ms-calculos:${{ github.run_id }}
                docker tag ${{ secrets.DOCKER_USERNAME }}/ms-calculos-processor:latest ${{ secrets.DOCKER_USERNAME }}/ms-calculos-processor:${{ github.run_id }}
                docker push ${{ secrets.DOCKER_USERNAME }}/ms-calculos:${{ github.run_id }}
                docker push ${{ secrets.DOCKER_USERNAME }}/ms-calculos-processor:${{ github.run_id }}

